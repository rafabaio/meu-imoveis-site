<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meus Imóveis</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { font-family: system-ui, Arial; margin:0; }
    header { padding:12px 16px; border-bottom:1px solid #eee; }
    .wrap { display:grid; grid-template-columns: 420px 1fr; gap:8px; height: calc(100vh - 56px); }
    #lista { overflow:auto; padding:10px; }
    .card { border:1px solid #e5e7eb; border-radius:10px; margin:8px 0; overflow:hidden; }
    .card img { width:100%; height:160px; object-fit:cover; display:block; }
    .card .b { padding:10px; }
    .tags { font-size:12px; color:#555; }
    #map { height:100%; width:100%; }
    .filtros { display:flex; gap:8px; padding:8px; position:sticky; top:0; background:#fff; z-index:1; border-bottom:1px solid #eee;}
    input, select { padding:6px 8px; border:1px solid #ddd; border-radius:8px; }
    .price { font-weight:700; }
  </style>
</head>
<body>
  <header>
    <strong>Meus Imóveis</strong> — catálogo privado
  </header>

  <div class="wrap">
    <aside id="lista">
      <div class="filtros">
        <input id="q" placeholder="Buscar (bairro, título...)" />
        <select id="quartos">
          <option value="">Quartos</option>
          <option>1</option><option>2</option><option>3</option><option>4+</option>
        </select>
        <input id="precoMax" type="number" placeholder="Preço máx (R$)" />
        <button id="filtrar">Filtrar</button>
        <button id="limpar">Limpar</button>
      </div>
      <div id="cards"></div>
    </aside>

    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Estado
    let dados = [], marcadores = [], mapa, camada;

    // Helpers
    const brl = n => n.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});

    // Carrega dados
    fetch('data/imoveis.json').then(r=>r.json()).then(json=>{
      dados = json;
      init();
    });

    function init() {
      // Mapa
      mapa = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(mapa);

      render(dados);
      fitBoundsToData(dados);
      document.getElementById('filtrar').onclick = aplicarFiltros;
      document.getElementById('limpar').onclick = ()=>{
        document.getElementById('q').value='';
        document.getElementById('quartos').value='';
        document.getElementById('precoMax').value='';
        aplicarFiltros();
      }
    }

    function aplicarFiltros(){
      const q = document.getElementById('q').value.trim().toLowerCase();
      const quartos = document.getElementById('quartos').value;
      const precoMax = Number(document.getElementById('precoMax').value || Infinity);

      const filtrados = dados.filter(d=>{
        const texto = (d.titulo+' '+d.bairro+' '+d.empreendimento).toLowerCase();
        const okTexto = !q || texto.includes(q);
        const qts = d.quartos || 0;
        const okQuartos = !quartos || (quartos==='4+' ? qts>=4 : qts==Number(quartos));
        const okPreco = (d.preco||0) <= precoMax;
        return okTexto && okQuartos && okPreco;
      });

      render(filtrados);
      fitBoundsToData(filtrados);
    }

    function render(lista){
      // limpa camada
      if(camada) { mapa.removeLayer(camada); }
      marcadores = lista.filter(d=>d.lat && d.lng).map(d=>{
        const m = L.marker([d.lat, d.lng]).bindPopup(`<b>${d.titulo}</b><br>${brl(d.preco)}<br>${d.bairro}`);
        m.on('click', ()=> scrollToCard(d.id));
        return m;
      });
      camada = L.layerGroup(marcadores).addTo(mapa);

      // cards
      const el = document.getElementById('cards');
      el.innerHTML = '';
      for(const d of lista){
        const foto = (d.fotos&&d.fotos[0]) || 'https://placehold.co/600x400?text=sem+foto';
        const div = document.createElement('div');
        div.className='card';
        div.id = 'card-'+d.id;
        div.innerHTML = `
          <img src="${foto}" alt="${d.titulo}">
          <div class="b">
            <div class="price">${brl(d.preco||0)}</div>
            <div><strong>${d.titulo}</strong></div>
            <div class="tags">${d.quartos||0}q • ${d.banheiros||0}b • ${d.vagas||0}v • ${d.area||0} m²</div>
            <div>${d.bairro}, ${d.cidade} - ${d.uf}</div>
            <div style="margin-top:6px;">
              <a href="${d.linkLead||'#'}" target="_blank">Tenho interesse</a>
            </div>
          </div>`;
        el.appendChild(div);
      }
    }

    function fitBoundsToData(lista){
      const pts = lista.filter(d=>d.lat && d.lng).map(d=>[d.lat, d.lng]);
      if(pts.length){
        const bounds = L.latLngBounds(pts);
        mapa.fitBounds(bounds.pad(0.2));
      } else {
        mapa.setView([-15.78,-47.93], 4); // Brasil
      }
    }

    function scrollToCard(id){
      const c = document.getElementById('card-'+id);
      if(c){ c.scrollIntoView({behavior:'smooth', block:'start'}); }
    }
  </script>
</body>
</html>
